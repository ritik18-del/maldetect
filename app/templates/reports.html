<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MalDetect - Reports</title>
  <link rel="stylesheet" href="/static/css/dashboard.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .container{max-width:1100px;margin:0 auto;padding:24px;color:#e6edf3}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{padding:16px;border:1px solid #334155;border-radius:8px;background:rgba(255,255,255,0.04)}
    .btn{padding:10px 14px;border-radius:6px;border:1px solid #334155;background:#111827;color:#e6edf3;cursor:pointer}
    .btn.primary{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .input{padding:8px 10px;border:1px solid #334155;border-radius:6px;background:#0b1220;color:#e6edf3}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:12px 0}
    .stat{padding:12px;border:1px solid #334155;border-radius:8px;background:#0b1220;text-align:center}
    .table-wrap{max-height:380px;overflow:auto;border:1px solid #334155;border-radius:8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #233047;font-size:14px}
    .muted{color:#94a3b8}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0}
  </style>
  <script>
    let previewData = [];
    let currentPage = 1;
    let totalPages = 1;
    document.addEventListener('DOMContentLoaded', async () => { await refreshStats(); await loadPreview(1); });

    async function refreshStats(){
      try{
        const r = await fetch('/api/dashboard/stats');
        if(!r.ok) return;
        const d = await r.json();
        const s = d.statistics||{};
        setText('statTotal', s.total_scans||0);
        setText('statMal', s.malicious_count||0);
        setText('statBen', s.benign_count||0);
        const pct = s.total_scans? ((s.malicious_count||0)/s.total_scans*100).toFixed(1):0;
        setText('statRate', pct+'%');
      }catch{}
    }

    async function loadPreview(page){
      if(typeof page === 'number') currentPage = Math.max(1, page);
      const per = Number(document.getElementById('per')?.value)||10;
      const r = await fetch(`/api/scans?page=${currentPage}&per_page=${per}`);
      const j = await r.json();
      previewData = (j.scans||[]);
      totalPages = j.pages || 1;
      const pageInfo = document.getElementById('pageInfo');
      if(pageInfo) pageInfo.textContent = `${currentPage} / ${totalPages}`;
      renderPreview();
    }

    function renderPreview(){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      const label = document.getElementById('filterLabel')?.value || '';
      const algo = document.getElementById('filterAlgo')?.value || '';
      const nameq = (document.getElementById('filterName')?.value || '').trim().toLowerCase();
      const rows = previewData.filter(x=>{
        if(label && x.label !== label) return false;
        if(algo && String(x.algorithm||'').toLowerCase() !== algo) return false;
        if(nameq && !String(x.filename||'').toLowerCase().includes(nameq)) return false;
        return true;
      });
      rows.forEach(x=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${x.scan_timestamp||'-'}</td>
          <td>${escapeHtml(x.filename)}</td>
          <td>${x.label}</td>
          <td>${x.algorithm?.toUpperCase?.()||'-'}</td>
          <td class="muted">${(x.confidence*100).toFixed(1)}%</td>
          <td class="muted">${formatBytes(x.file_size)}</td>
        `;
        tbody.appendChild(tr);
      });
      setText('rowsCount', rows.length);
    }

    async function exportData(fmt){
      const limit = Number(document.getElementById('limit').value)||1000;
      const url = `/api/export/scans?format=${fmt}&limit=${limit}`;
      const btn = document.getElementById(`btn-${fmt}`);
      const old = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
      try{
        if(fmt==='json'){
          const r = await fetch(url);
          const blob = new Blob([JSON.stringify(await r.json(), null, 2)], {type:'application/json'});
          downloadBlob(blob, `maldetect-${Date.now()}.json`);
        } else {
          const r = await fetch(url);
          const text = await r.text();
          const blob = new Blob([text], {type:'text/csv'});
          downloadBlob(blob, `maldetect-${Date.now()}.csv`);
        }
      } finally { btn.disabled=false; btn.innerHTML = old; }
    }

    function downloadBlob(blob, filename){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename; document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(a.href);
    }
    function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent = v; }
    function escapeHtml(s){return String(s).replace(/[&<>"']+/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}
    function formatBytes(n){const b=Number(n)||0;if(b<1024) return `${b} B`;const u=['KB','MB','GB'];let i=-1,v=b;do{v/=1024;i++;}while(v>=1024&&i<u.length-1);return `${v.toFixed(2)} ${u[i]}`}
  </script>
</head>
<body>
  <div class="container">
    <h1><i class="fas fa-file-alt"></i> Reports</h1>
    <div class="grid">
      <div class="card">
        <h3>Export Scan Data</h3>
        <div class="controls" style="margin:8px 0">
          <label for="limit">Limit</label>
          <input id="limit" class="input" type="number" min="1" max="5000" value="1000" />
          <button id="btn-csv" class="btn primary" onclick="exportData('csv')"><i class="fas fa-file-csv"></i> CSV</button>
          <button id="btn-json" class="btn" onclick="exportData('json')"><i class="fas fa-code"></i> JSON</button>
          <button class="btn" onclick="loadPreview()"><i class="fas fa-eye"></i> Preview</button>
        </div>
        <div class="stats">
          <div class="stat"><div class="muted">Total</div><div id="statTotal">0</div></div>
          <div class="stat"><div class="muted">Malicious</div><div id="statMal">0</div></div>
          <div class="stat"><div class="muted">Benign</div><div id="statBen">0</div></div>
          <div class="stat"><div class="muted">Threat Rate</div><div id="statRate">0%</div></div>
        </div>
        <div class="toolbar">
          <input id="filterName" class="input" placeholder="Filter filename..." oninput="renderPreview()" />
          <select id="filterLabel" class="input" onchange="renderPreview()">
            <option value="">All labels</option>
            <option value="malicious">Malicious</option>
            <option value="benign">Benign</option>
          </select>
          <select id="filterAlgo" class="input" onchange="renderPreview()">
            <option value="">All algos</option>
            <option value="rf">RF</option>
            <option value="dt">DT</option>
            <option value="svm">SVM</option>
            <option value="nb">NB</option>
            <option value="mlp">MLP</option>
          </select>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr><th>Timestamp</th><th>Filename</th><th>Label</th><th>Algorithm</th><th>Conf</th><th>Size</th></tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:6px;display:flex;gap:12px;align-items:center">
          Rows: <span id="rowsCount">0</span>
          <span style="margin-left:auto" class="muted">Page:</span>
          <button class="btn" onclick="loadPreview(currentPage-1)" title="Previous">Prev</button>
          <span id="pageInfo">1 / 1</span>
          <button class="btn" onclick="loadPreview(currentPage+1)" title="Next">Next</button>
          <span class="muted">Per page</span>
          <input id="per" class="input" type="number" min="1" max="200" value="10" onchange="loadPreview(1)" />
          <button class="btn" onclick="loadPreview(currentPage)" title="Refresh"><i class="fas fa-sync"></i></button>
        </div>
      </div>
      <div class="card">
        <h3>Notes</h3>
        <ul style="margin:8px 0 0 18px">
          <li>Use Dashboard for visual analytics.</li>
          <li>Use CSV for spreadsheets; JSON for programmatic use.</li>
          <li>Preview shows first page from /api/scans.</li>
        </ul>
      </div>
    </div>
  </div>
</body>
</html>


